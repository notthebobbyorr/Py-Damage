name: Update Data

on:
  # Run daily at 6 AM UTC (1-2 AM EST depending on DST)
  schedule:
    - cron: '0 6 * * *'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      min_season:
        description: 'Minimum season year'
        required: false
        default: '2015'
      max_season:
        description: 'Maximum season year'
        required: false
        default: '2025'

env:
  # Database connection settings
  POOBAH_DB: ${{ secrets.POOBAH_DB }}
  POOBAH_USER: ${{ secrets.POOBAH_USER }}
  POOBAH_PASSWORD: ${{ secrets.POOBAH_PASSWORD }}
  POOBAH_HOST: ${{ secrets.POOBAH_HOST }}
  POOBAH_PORT: ${{ secrets.POOBAH_PORT }}

jobs:
  update-data:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas polars psycopg2-binary pyarrow
          pip install catboost pygam scikit-learn joblib python-dotenv

      - name: Run data pull
        shell: pwsh
        run: |
          $minSeason = if ("${{ github.event.inputs.min_season }}") { "${{ github.event.inputs.min_season }}" } else { "2015" }
          $maxSeason = if ("${{ github.event.inputs.max_season }}") { "${{ github.event.inputs.max_season }}" } else { "2025" }
          python data_pull.py --min-season $minSeason --max-season $maxSeason --level-ids 1

      - name: Run data aggregation
        shell: pwsh
        run: |
          $minSeason = if ("${{ github.event.inputs.min_season }}") { "${{ github.event.inputs.min_season }}" } else { "2015" }
          $maxSeason = if ("${{ github.event.inputs.max_season }}") { "${{ github.event.inputs.max_season }}" } else { "2025" }
          python data_aggregate.py --min-season $minSeason --max-season $maxSeason

      - name: Commit and push changes
        shell: pwsh
        run: |
          $changes = git status --porcelain
          if ($changes) {
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add -A
            $date = Get-Date -Format "yyyy-MM-dd"
            git commit -m "Update data files $date"
            git push
            Write-Host "Changes committed and pushed"
          } else {
            Write-Host "No changes to commit"
          }
